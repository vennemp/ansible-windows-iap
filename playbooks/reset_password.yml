---
- name: Reset Windows password and store vault-encrypted credentials
  hosts: windows
  gather_facts: false
  serial: 1

  tasks:
    - name: Reset Windows password via gcloud
      gcp_reset_windows_password:
        instance_name: "{{ gcp_instance_name | default(inventory_hostname) }}"
        project: "{{ gcp_project }}"
        zone: "{{ gcp_zone }}"
        user: "{{ windows_user | default('ansible_admin') }}"
        vault_encrypt: true
        vault_password_file: "{{ lookup('env', 'ANSIBLE_VAULT_PASSWORD_FILE') | default(playbook_dir ~ '/../.vault_pass', true) }}"
        host_vars_dir: "{{ playbook_dir }}/../host_vars"
      delegate_to: localhost
      register: reset_result

    - name: Display reset result
      ansible.builtin.debug:
        msg: >-
          Password reset for {{ reset_result.username }}
          on {{ gcp_instance_name | default(inventory_hostname) }}.
          Credentials stored in {{ reset_result.vault_file | default('N/A') }}.
